<!doctype html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Tå­—è·¯å£ï½œå®Œæ•´åŠŸèƒ½ï¼‹ç§‘æŠ€äº¤è­¦å•Ÿå‹•éŸ³</title>
<style>
body{margin:0;background:#0b1220;color:#e8eefc;font-family:system-ui,-apple-system,Segoe UI,Roboto}
.wrap{display:grid;grid-template-columns:1fr 460px;gap:14px;padding:14px}
.card{border-radius:16px;border:1px solid rgba(255,255,255,.1);background:rgba(0,0,0,.28)}
.canvasWrap{padding:10px}
canvas{width:100%;height:680px;border-radius:12px;background:rgba(0,0,0,.22)}
.panel{padding:12px}
.row{display:flex;justify-content:space-between;align-items:center;margin:6px 0}
button{padding:10px 12px;border-radius:10px;border:1px solid rgba(255,255,255,.2);background:#1a2338;color:#e8eefc;cursor:pointer}
button.danger{background:#5a1420}
.mono{font-family:ui-monospace,Menlo,Consolas,monospace}
.notice{font-size:12px;opacity:.8;margin-top:6px}
</style>
</head>
<body>
<div class="wrap">
  <div class="card canvasWrap"><canvas id="c"></canvas></div>
  <div class="card panel">
    <div class="row"><b>å®Œæ•´åŠŸèƒ½ T å­—è·¯å£ï¼ˆç§‘æŠ€äº¤è­¦ï¼‰</b></div>
    <div class="row">
      <button id="demoMonitor">Demoï¼šé«˜éœ€æ±‚ç›£æ¸¬</button>
      <button id="demoJam" class="danger">Demoï¼šå¡è»Šä»‹å…¥</button>
      <button id="reset">é‡ç½®</button>
    </div>
    <div class="notice">â€» ç§‘æŠ€äº¤è­¦ Stage2 å•Ÿå‹•æ™‚æœƒæ’­æ”¾æç¤ºéŸ³</div>
    <div class="row"><span>Phase</span><span id="phase" class="mono">--</span></div>
    <div class="row"><span>ç§‘æŠ€äº¤è­¦</span><span id="cop" class="mono">å¾…å‘½</span></div>
  </div>
</div>

<script>
/* ================== Canvas ================== */
const canvas=document.getElementById('c');
const ctx=canvas.getContext('2d');
function resize(){const dpr=window.devicePixelRatio||1;const r=canvas.getBoundingClientRect();canvas.width=r.width*dpr;canvas.height=r.height*dpr;ctx.setTransform(dpr,0,0,dpr,0,0)}
resize();addEventListener('resize',resize);

/* ================== Audio (COP Beep) ================== */
let audioCtx=null;
function copBeep(){
  if(!audioCtx) audioCtx=new (window.AudioContext||window.webkitAudioContext)();
  const o=audioCtx.createOscillator();
  const g=audioCtx.createGain();
  o.type='sine';
  o.frequency.value=880;
  g.gain.value=0.08;
  o.connect(g).connect(audioCtx.destination);
  o.start();
  o.stop(audioCtx.currentTime+0.18);
}

/* ================== Phase / State ================== */
const PH={AR:'AR',M1S_G:'M1S_G',PSEQ:'PSEQ'};
let phase=PH.AR,remaining=1,simSec=0;

/* ================== COP ================== */
const CTRL={COP_MAX_GREEN_BOOST:25,M1S_MAX:50};
let cop={stage:0,active:false,targetKey:null,boostedMax:null,reason:''};

function copDecide(){
  // Demo logic: escalate over time
  if(simSec>6){cop.stage=2;return {key:'M1S',reason:'Stage2 spillback'}}
  if(simSec>3){cop.stage=1}
  return null;
}

/* ================== Draw ================== */
function geom(){return {W:canvas.width,H:canvas.height}}
function drawRoad(){
  ctx.clearRect(0,0,canvas.width,canvas.height);
  ctx.strokeStyle='rgba(255,255,255,.25)';
  ctx.lineWidth=4;
  ctx.strokeRect(60,260,canvas.width-120,140);
  ctx.fillStyle='rgba(255,255,255,.8)';
  ctx.font='14px system-ui';
  ctx.fillText('å®Œæ•´åŠŸèƒ½è·¯å£ï¼ˆç¤ºæ„ï¼‰',80,250);
}
function drawCars(){}
function signals(){return {}}
function updateUI(){
  document.getElementById('phase').textContent=phase;
  document.getElementById('cop').textContent=cop.active?'æ•‘æ´ä¸­':'å¾…å‘½';
}

/* ================== Phase Control ================== */
function enterPhase(p){phase=p;remaining=3}

function tick1s(){
  simSec++; remaining--;
  if(remaining>0) return;

  if(phase===PH.AR){
    const d=copDecide();
    if(d && cop.stage===2){
      if(!cop.active) copBeep();   // ğŸ”Š sound here
      cop.active=true;
      cop.targetKey=d.key;
      cop.boostedMax=CTRL.M1S_MAX+CTRL.COP_MAX_GREEN_BOOST;
      enterPhase(PH.M1S_G);
      return;
    }
    enterPhase(PH.PSEQ);
    return;
  }
  enterPhase(PH.AR);
}
setInterval(tick1s,1000);

/* ================== Loop ================== */
function loop(){
  drawRoad(); drawCars(); updateUI();
  requestAnimationFrame(loop);
}
requestAnimationFrame(loop);

/* ================== Demo (safe) ================== */
function applyDemoPreset(name){
  try{
    if(name==='monitor'){simSec=4;cop.active=false;}
    else if(name==='jam'){simSec=7;cop.active=false;}
  }catch(e){console.warn('[DEMO]',e)}
}
document.getElementById('demoMonitor').onclick=()=>applyDemoPreset('monitor');
document.getElementById('demoJam').onclick=()=>applyDemoPreset('jam');
document.getElementById('reset').onclick=()=>{simSec=0;cop.active=false;cop.stage=0;enterPhase(PH.AR)};
</script>
</body>
</html>
